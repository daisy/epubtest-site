{%- extends 'base/base.html' -%}
{%- set title = "Admin" -%}
{%- set mainclass = "wide" -%}


{%- block content -%}

<h1>Admin tasks</h1>

<h2>Requests to publish</h2>

<table>
    <thead>
        <tr>
            <td>Reading System</td>
            <td>Assistive Technology</td>
            <td>Operating System</td>
            <td>Topic</td>
            <td>Requested on</td>
            <td>User</td>
            <td>Approve</td>
        </tr>
    </thead>
    <tbody>
        {%- for request in requests -%}
        <tr>
            <td>{{request.answerSet.testingEnvironment.readingSystem.name}} {{request.answerSet.testingEnvironment.readingSystem.version}}</td>
            <td>{{request.answerSet.testingEnvironment.assistiveTechnology.name}}</td>
            <td>{{request.answerSet.testingEnvironment.os.name}} {{request.answerSet.testingEnvironment.os.version}}</td>
            <td>{{request.answerSet.testBook.topic.id}}</td>
            <td>{{request.created | date("YYYY-MM-DD")}}</td>
            <td>{{request.answerSet.user.name}}</td>
            <td>
                <form method="POST" action="/forms/approve-request">
                    <input type="hidden" name="requestId" value="{{request.id}}"></input>
                    <input type="hidden" name="answerSetId" value="{{request.answerSet.id}}"></input>
                    <input type="submit" name="submit" value="Approve"></input>
                </form>
            </td>
        {%- endfor -%}
    </tbody>
</table>

<h1>All testing environments</h1>
{%- for testingEnvironment in testingEnvironments -%}

        <h2 id="{{testingEnvironment.id}}"><span>{{testingEnvironment.readingSystem.name}} {{testingEnvironment.readingSystem.version}}</span>,
            <span>{{testingEnvironment.assistiveTechnology.name}} </span>,
            <span>{{testingEnvironment.os.name}} {{testingEnvironment.os.version}}</span>
        </h2>

        <table class="striped">
            <thead>
                <tr>
                    <th>Topic</th>
                    {#<th>Status</th>#}
                    <th>Score</th>
                    <th>Edit</th>

                    <th>Publish</th>
                </tr>
            </thead>
            <tbody>
            {%- for answerSet in testingEnvironment.answerSetsByTestingEnvironmentId.nodes -%}
            <tr>
                <td>{{answerSet.testBook.topic.id}}</td>
                {#<td>Up to date</td>#}
                <td>{%-if answerSet.score -%}{{answerSet.score | round(1)}}{%- endif -%}</td>
                <td><a href="/user/edit-results/{{answerSet.id}}">Edit</td>
                <td>
                    {%- set requestToPublish=getRequestToPublish(answerSet.id) -%}
                    {%- if answerSet.isPublic -%}
                    <a href="/results/{{testingEnvironment.id}}">Published</a>

                    {%- elif requestToPublish != null -%}
                    <span>Request pending</span>
                    {%- else -%}
                    <form method="POST" action="/forms/request-to-publish">
                        <input type="hidden" name="answerSetId" value="{{answerSet.id}}"/>
                        <input type="submit" name="submit" value="Request to publish"/>
                    </form>
                    {%- endif -%}
                </td>
            </tr>
            {%- endfor -%}
            </tbody>
        </table>
        
        
{%- endfor -%}
{%- endblock -%}