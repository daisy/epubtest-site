{%- extends 'base/base.html' -%}

{%- set mainclass="wide" -%}

{%- if isArchivesPage -%}
{%- set title="Archived Results" -%}
{%- else -%}
{%- set title="Results" -%}
{%- endif -%}

{%- block content -%}

<script type="module" src="/js/table.js"></script>
<script type="module">
        import { table } from '/js/table.js';
        let smarttable = new table();
        window.addEventListener("load", () => {
            let data = [
                {%- for testenv in testingEnvironments -%}
                    {
                        testingEnvironment: {
                            id: {{testenv.id}},
                            readingSystem: {
                                name: "{{testenv.readingSystem.name }}",
                                version: "{{testenv.readingSystem.version}}",
                                vendor: "{{testenv.readingSystem.vendor}}"
                            },
                            assistiveTechnology: {
                                name: "{{testenv.assistiveTechnology.name }}",
                                version: "{{testenv.assistiveTechnology.version}}",
                                vendor: "{{testenv.assistiveTechnology.vendor}}"
                            },
                            operatingSystem: {
                                name: "{{testenv.os.name }}",
                                version: "{{testenv.os.version}}",
                                vendor: "{{testenv.os.vendor}}"
                            },
                            {%- if testenv.device -%}
                            device: {
                                name: "{{testenv.device.name }}",
                                version: "{{testenv.device.version}}",
                                vendor: "{{testenv.device.vendor}}"
                            },
                            {%- endif -%}
                            {%- if testenv.browser -%}
                            browser: {
                                name: "{{testenv.browser.name }}",
                                version: "{{testenv.browser.version}}",
                                vendor: "{{testenv.browser.vendor}}"
                            }
                            {%- endif -%}
                        },
                        results: [
                            {%- for topic in topics -%}
                            {%- set score=getfortopic(testenv.answerSetsByTestingEnvironmentId.nodes, topic).score -%}                
                            {%-if score > 0 -%}{{score | round(1)}}{%- else -%} -1 {%- endif -%},
                            {%- endfor -%}
                        ]
                    },
                {%- endfor -%}
            ];

            let tableElm = document.getElementById("results-table");
            let tbody = tableElm.getElementsByTagName("tbody")[0];
            smarttable.init(
                tbody, data, 0, 'asc'
            );
        });

        function sortby(idx) {
            smarttable.sortBy(idx);
        }
        function headerKeypress(event, idx) {
            if (event.keycode ==13) {
                smarttable.sortBy(idx);
            }
        }
        window.sortby = sortby;
        window.headerKeypress = headerKeypress;
    </script>
{%- if isArchivesPage -%}
<p>The following Testing Environments have been archived.</p>
{%- else -%}
<p>The following represents how well each Testing Environment (Reading System or Reading System + Assistive Technology 
    combination) performed in a series of tests, organized by topic. Learn more about the tests on 
    the <a href="/test-books">test books page</a>.</p>
{%- endif -%}

<table class="wide striped sortable" id="results-table" summary="Reading system testing results">
    <thead>
        <tr>
            <th title="Select to sort"
                onkeydown="headerKeypress(event, 0)" 
                onclick="sortby(0)"
                tabindex="0">
                Testing Environment
            </th>
            {%- for topic in topics -%}
            {# loop.index is 1-based but it works here because the header row is "0" #}
            <th title="Select to sort"
                onkeydown="headerKeypress(event, {{loop.index}})" 
                onclick="sortby({{loop.index}})"
                tabindex="0">
                {{getTopicName(topic.id)}}
            </th>
            {%- endfor -%}
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

{%- if isArchivesPage == false -%}
<p><a href="/archive">Archived Results</a></p>
{%- endif -%}
{%- endblock -%}